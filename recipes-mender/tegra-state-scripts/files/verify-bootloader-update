#!/bin/sh

#
# Mender state script: ArtifactVerifyReboot_50_verify-bootloader-update
# Verifies UEFI capsule update succeeded (if one was staged)
# - Checks bootloader version changed
# - Verifies ESRT status
# - Logs nvbootctrl status (informational only, not trusted)
#

set -eu

log() {
    printf '%s\n' "mender-verify-bl: $*" >&2
}

# Mender's script environment can be minimal
export PATH=/usr/sbin:/sbin:/usr/bin:/bin:$PATH

# Check if a bootloader update was requested
MARKER_FILE="/var/lib/edgeos/update-bootloader"
VERSION_BEFORE_FILE="/var/lib/mender/tegra-bl-version-before"

# If no marker file exists, bootloader update was not requested
if [ ! -f "${MARKER_FILE}" ]; then
    log "no bootloader update marker, skipping verification"
    exit 0
fi

log "bootloader update marker found, verifying capsule update succeeded"

# Require nvbootctrl for version checking
if ! command -v nvbootctrl >/dev/null 2>&1; then
    log "ERROR: nvbootctrl not found, cannot verify bootloader update"
    exit 1
fi

###############################################################################
# PRIMARY VERIFICATION: Bootloader Version Comparison
###############################################################################

# Get current bootloader version
version_after=$(nvbootctrl dump-slots-info 2>/dev/null | grep -i "Current version" | awk '{print $3}')

if [ -z "${version_after}" ]; then
    log "ERROR: could not determine current bootloader version"
    exit 1
fi

log "current bootloader version: ${version_after}"

# If we have the before version, compare
if [ -f "${VERSION_BEFORE_FILE}" ]; then
    version_before=$(cat "${VERSION_BEFORE_FILE}")
    log "bootloader version before update: ${version_before}"

    if [ "${version_after}" != "${version_before}" ]; then
        log "SUCCESS: bootloader version changed (${version_before} â†’ ${version_after})"
        log "capsule update verified via version comparison"

        # Cleanup marker and version files
        rm -f "${MARKER_FILE}" "${VERSION_BEFORE_FILE}"
        exit 0
    else
        log "WARNING: bootloader version unchanged (${version_before})"
        log "capsule may have failed or same version was re-installed"
        # Continue to ESRT check
    fi
else
    log "WARNING: no pre-update version recorded, cannot compare versions"
    # Continue to ESRT check
fi

###############################################################################
# SECONDARY VERIFICATION: ESRT Status (NVIDIA Official Recommendation)
###############################################################################

ESRT_STATUS_FILE="/sys/firmware/efi/esrt/entries/entry0/last_attempt_status"

if [ -r "${ESRT_STATUS_FILE}" ]; then
    esrt_status=$(cat "${ESRT_STATUS_FILE}")
    log "ESRT last_attempt_status: ${esrt_status}"

    case "${esrt_status}" in
        0)
            log "SUCCESS: ESRT status indicates successful capsule update"
            log "capsule update verified via ESRT"

            # Cleanup marker and version files
            rm -f "${MARKER_FILE}" "${VERSION_BEFORE_FILE}"
            exit 0
            ;;
        1)
            log "ERROR: ESRT status 1 (insufficient resources)"
            exit 1
            ;;
        2)
            log "ERROR: ESRT status 2 (incorrect version)"
            exit 1
            ;;
        3)
            log "ERROR: ESRT status 3 (invalid image format)"
            exit 1
            ;;
        4)
            log "ERROR: ESRT status 4 (authentication error)"
            exit 1
            ;;
        5)
            log "ERROR: ESRT status 5 (power event - AC not connected)"
            exit 1
            ;;
        6)
            log "ERROR: ESRT status 6 (power event - insufficient battery)"
            exit 1
            ;;
        6163)
            log "ERROR: ESRT status 6163 (NVIDIA vendor error - capsule authentication failure)"
            log "CAUSE: No trusted certificates enrolled in device UEFI firmware"
            log "SOLUTION: Device must be reflashed with UefiDefaultSecurityKeys.dtbo containing test certificates"
            log "See uefi-test-keys/README.md for detailed instructions on:"
            log "  1. Extracting EDK2 test certificates"
            log "  2. Generating UefiDefaultSecurityKeys.dts"
            log "  3. Rebuilding with enrolled certificates"
            log "  4. Reflashing the device"
            exit 1
            ;;
        6164)
            log "ERROR: ESRT status 6164 (NVIDIA vendor error - SKU incompatibility)"
            log "CAUSE: Device SKU not included in capsule package"
            log "SOLUTION: Check TEGRA_BUPGEN_SPECS includes your device's board SKU"
            log "Your device: $(cat /proc/device-tree/compatible | tr '\\0' ' ')"
            exit 1
            ;;
        *)
            # Check if it's a NVIDIA vendor error (0x1000-0x4000 range)
            if [ "${esrt_status}" -ge 4096 ] && [ "${esrt_status}" -le 16384 ]; then
                log "ERROR: ESRT status ${esrt_status} (0x$(printf '%x' ${esrt_status})) - NVIDIA vendor-specific error"
                log "This is a NVIDIA UEFI firmware error code not in the standard UEFI specification"
                log "Common causes:"
                log "  - Capsule authentication failure (missing certificates)"
                log "  - SKU/board compatibility mismatch"
                log "  - Firmware validation failure"
                log "Contact NVIDIA support or check edk2-nvidia sources for error code details"
                exit 1
            fi
            log "WARNING: unknown ESRT status: ${esrt_status}"
            ;;
    esac
else
    log "WARNING: ESRT status file not accessible"
fi

###############################################################################
# TERTIARY INFORMATION: nvbootctrl Status (Not Trusted, Logged Only)
###############################################################################

# NVIDIA documentation warns: "When single partition image Capsule update is
# complete, the Capsule update status in the output of nvbootctrl command is
# not reliable."
#
# We log it for informational purposes but don't use it for pass/fail decisions.

capsule_status=$(nvbootctrl dump-slots-info 2>/dev/null | grep -i "Capsule update status" | awk '{print $NF}')

if [ -n "${capsule_status}" ]; then
    log "nvbootctrl capsule status: ${capsule_status} (informational only, not trusted)"

    case "${capsule_status}" in
        0) log "  (nvbootctrl: no capsule update occurred - known to be unreliable)" ;;
        1) log "  (nvbootctrl: capsule update successful - known to be unreliable)" ;;
        2) log "  (nvbootctrl: capsule installed but boot failed - known to be unreliable)" ;;
        3) log "  (nvbootctrl: capsule install failed - known to be unreliable)" ;;
        *) log "  (nvbootctrl: unknown status)" ;;
    esac
else
    log "WARNING: could not read nvbootctrl capsule status"
fi

###############################################################################
# FALLBACK VERIFICATION: Boot Success
###############################################################################

# If we've reached here:
# - Version comparison was inconclusive or unavailable
# - ESRT status was not definitively successful or unavailable
# - But the system booted successfully (we're running this script)

log "WARNING: could not definitively verify capsule update via version or ESRT"
log "system booted successfully, assuming update succeeded"
log "this is a fallback verification - manual check recommended"

# Log current state for debugging
log "current state:"
nvbootctrl dump-slots-info 2>/dev/null | while read line; do
    log "  ${line}"
done

# Consider this a success (boot succeeded)
# Cleanup marker and version files
rm -f "${MARKER_FILE}" "${VERSION_BEFORE_FILE}"

log "verification complete (fallback to boot success)"
exit 0
